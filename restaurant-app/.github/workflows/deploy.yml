name: CD ‚Äî Deploy to AWS EC2

on:
  push:
    branches:
      - main
      - master

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Gate: Re-run CI before deploying
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ci-gate:
    name: PHP Syntax Check (Gate)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, mbstring, zip, gd, curl
          coverage: none

      - name: Check PHP syntax (all files)
        run: |
          echo "üîç Checking PHP syntax before deploy..."
          ERROR_COUNT=0
          while IFS= read -r -d '' file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Syntax error in: $file"
              php -l "$file"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < <(find . -name "*.php" -not -path "./menus/vendor/*" -print0)

          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ùå Found $ERROR_COUNT file(s) with syntax errors. Aborting deploy."
            exit 1
          else
            echo "‚úÖ PHP syntax check passed. Proceeding to deploy."
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job: Deploy to AWS EC2 via SSH
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-22.04
    needs: ci-gate   # Only deploy if CI gate passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to AWS EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Starting deployment on AWS EC2..."

            # ‚îÄ‚îÄ Pull latest code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # Repo root is at /var/www/html/restaurant-app-repo
            # EC2_DEPLOY_PATH is symlinked to restaurant-app-repo/restaurant-app
            git -C /var/www/html/restaurant-app-repo fetch origin main
            git -C /var/www/html/restaurant-app-repo reset --hard origin/main
            echo "‚úÖ Code updated."

            # ‚îÄ‚îÄ Write .env file from secrets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            cat > ${{ secrets.EC2_DEPLOY_PATH }}/menus/.env << 'ENVEOF'
            HOST=${{ secrets.DB_HOST }}
            USERNAME=${{ secrets.DB_USERNAME }}
            PASSWORD=${{ secrets.DB_PASSWORD }}
            DB=${{ secrets.DB_NAME }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            ENVEOF
            chmod 600 ${{ secrets.EC2_DEPLOY_PATH }}/menus/.env
            echo "‚úÖ .env file written."

            # ‚îÄ‚îÄ Install Composer dependencies ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            cd ${{ secrets.EC2_DEPLOY_PATH }}/menus
            COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            echo "‚úÖ Composer dependencies installed."

            # ‚îÄ‚îÄ Set correct file permissions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            sudo chown -R www-data:www-data ${{ secrets.EC2_DEPLOY_PATH }}
            sudo chmod -R 755 ${{ secrets.EC2_DEPLOY_PATH }}
            sudo chmod -R 775 ${{ secrets.EC2_DEPLOY_PATH }}/qrcodes
            sudo chmod -R 775 ${{ secrets.EC2_DEPLOY_PATH }}/menus/qrcodes
            sudo chmod 600 ${{ secrets.EC2_DEPLOY_PATH }}/menus/.env
            echo "‚úÖ Permissions set."

            # ‚îÄ‚îÄ Reload Apache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            sudo systemctl reload apache2
            echo "‚úÖ Apache reloaded."

            echo ""
            echo "üéâ Deployment complete at $(date)"
            echo "üåê Live at: http://${{ secrets.EC2_HOST }}"
